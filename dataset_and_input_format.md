# BaziQA 数据集格式与模型输入说明

> 本文档详细描述 BaziQA 数据集的文件格式、字段定义、排盘结果结构，以及如何将排盘信息格式化后输入给大语言模型。

---

## 1. 数据集概览

| 属性 | 说明 |
|------|------|
| 数据集名称 | BaziQA（内部文件名沿用 `contest8_*`） |
| 时间跨度 | 2021–2025（共 5 年） |
| 每年规模 | 8 位命主 × 5 道选择题 = 40 题 |
| 总计 | 200 道四选一选择题 |
| 来源 | 专业八字命理竞赛真题 |

---

## 2. 数据文件结构

### 2.1 题目文件（Questions）

**路径**：`data/contest8_{year}.json`

**顶层结构**（JSON Array）：

```json
[
  {
    "contest_id": "contest8_2025",
    "current_year": "2025",
    "description": "竞赛说明...",
    "total_questions": 40
  },
  { /* 命主 1 */ },
  { /* 命主 2 */ },
  ...
]
```

**命主对象字段**：

| 字段 | 类型 | 说明 | 示例 |
|------|------|------|------|
| `person_id` | string | 命主唯一标识 | `"guangdong_female_19511114_P001"` |
| `name` | string | 命主描述性名称 | `"1951年广东出生女性"` |
| `profile` | object | 出生信息 | 见下表 |
| `categories` | object | 题目分类（预留字段） | `{"感情": [], "财富": [], ...}` |
| `questions` | array | 该命主的 5 道选择题 | 见下表 |

**`profile` 字段**：

| 子字段 | 类型 | 说明 | 示例 |
|--------|------|------|------|
| `birth.year` | int | 出生年（公历） | `1951` |
| `birth.month` | int | 出生月（公历） | `11` |
| `birth.day` | int | 出生日（公历） | `14` |
| `birth.hour` | int | 出生时（24小时制） | `10` |
| `birth.minute` | int | 出生分 | `0` |
| `birth.place` | string | 出生地 | `"广东，中国"` |
| `birth.raw` | string | 原始出生信息 | `"1951-11-14T09:00 - 广东..."` |
| `gender` | string | 性别 | `"female"` / `"male"` |

**`questions` 数组元素**：

| 字段 | 类型 | 说明 | 示例 |
|------|------|------|------|
| `question_id` | string | 题目唯一标识 | `"guangdong_female_19511114_P001-Q1"` |
| `question` | string | 题干文本 | `"此命出生家境如何？"` |
| `options` | array[string] | 四个选项 | `["A. 富裕", "B. 贫穷", ...]` |
| `answer` | string | 正确答案 | `"B"` |

### 2.2 排盘结果文件（Bazi Results）

**路径**：`result/bazi-results/contest8_{year}_bazi_results.json`

**说明**：排盘结果由外部八字排盘服务生成，包含完整的四柱、十神、大运、流年等命理信息。

**顶层结构**：JSON Array，每个元素对应一位命主的排盘结果。

---

## 3. 排盘结果字段详解

每位命主的排盘结果包含以下主要部分：

### 3.1 基本信息

| 字段 | 类型 | 说明 |
|------|------|------|
| `person_id` | string | 对应题目文件中的 `person_id` |
| `name` | string | 命主名称 |
| `gender` | string | 性别（`"male"`/`"female"`） |
| `genderCn` | string | 性别中文（`"男"`/`"女"`） |
| `zao` | string | 命造（`"乾造"`/`"坤造"`） |

### 3.2 日期时间（`dateInfo`）

| 字段 | 说明 | 示例 |
|------|------|------|
| `solarStr` | 公历日期时间 | `"1951-11-14 10:00:00"` |
| `lunarStr2` | 农历日期（中文） | `"一九五一年十月十六巳时"` |
| `xingQi` | 星期 | `"周三"` |
| `jiJie` | 季节 | `"孟冬"` |
| `shengXiao` | 生肖 | `"兔"` |
| `xingZuo` | 星座 | `"天蝎座"` |

### 3.3 四柱八字

| 字段 | 说明 | 示例 |
|------|------|------|
| `siZhu.yearGanZhi` | 年柱干支 | `"辛卯"` |
| `siZhu.monthGanZhi` | 月柱干支 | `"己亥"` |
| `siZhu.dayGanZhi` | 日柱干支 | `"戊午"` |
| `siZhu.hourGanZhi` | 时柱干支 | `"丁巳"` |
| `tianGan` | 四柱天干 | `{year: "辛", month: "己", day: "戊", hour: "丁"}` |
| `diZhi` | 四柱地支 | `{year: "卯", month: "亥", day: "午", hour: "巳"}` |

### 3.4 十神系统

| 字段 | 说明 | 示例 |
|------|------|------|
| `zhuXing` | 主星（天干十神） | `{year: "伤官", month: "劫财", day: "元女", hour: "正印"}` |
| `cangGan` | 藏干 | `{year: ["乙"], month: ["壬","甲"], ...}` |
| `fuXing` | 副星（藏干十神） | `{year: ["正官"], month: ["偏财","七杀"], ...}` |

### 3.5 五行分析

| 字段 | 说明 | 示例 |
|------|------|------|
| `ganZhiWuXing` | 干支五行 | `{year: "金木", month: "土水", ...}` |
| `wuXingCount` | 五行数量统计 | `{木: 1, 火: 3, 土: 2, 金: 1, 水: 1}` |
| `wuXingQueShi` | 五行缺失 | `[]` 或 `["水"]` |
| `wuXingWangShuai` | 五行旺衰 | `["水旺", "木相", "金休", ...]` |

### 3.6 十二长生与纳音

| 字段 | 说明 | 示例 |
|------|------|------|
| `xingYun` | 十二长生 | `{year: "沐浴", month: "绝", day: "帝旺", hour: "临官"}` |
| `naYin` | 纳音五行 | `{year: "松柏木", month: "平地木", ...}` |

### 3.7 神煞

| 字段 | 说明 |
|------|------|
| `shenSha.year` | 年柱神煞（如 `["桃花"]`） |
| `shenSha.month` | 月柱神煞 |
| `shenSha.day` | 日柱神煞 |
| `shenSha.hour` | 时柱神煞 |

### 3.8 干支关系

| 字段 | 说明 | 示例 |
|------|------|------|
| `tianGanLiuYi` | 天干关系 | `["戊辛相生", "丁辛相克", ...]` |
| `diZhiLiuYi` | 地支关系 | `["午亥暗合", "卯午相破", "巳亥相冲", ...]` |

### 3.9 空亡

| 字段 | 说明 | 示例 |
|------|------|------|
| `kongWang.year` | 年柱空亡 | `"午未"` |
| `kongWang.day` | 日柱空亡 | `"子丑"` |

### 3.10 胎元命宫

| 字段 | 说明 |
|------|------|
| `taiYuanMingGong.taiYuanGanZhi` | 胎元 |
| `taiYuanMingGong.taiXiGanZhi` | 胎息 |
| `taiYuanMingGong.mingGongGanZhi` | 命宫 |
| `taiYuanMingGong.shenGongGanZhi` | 身宫 |

### 3.11 大运信息（`daYunInfo`）

数组格式，每个元素为 `[起始年份, 起始年龄, 干支]`：

```json
[
  ["1951", "1", ""],        // 出生（无大运）
  ["1959", "9", "庚子"],    // 第1步大运
  ["1969", "19", "辛丑"],   // 第2步大运
  ...
]
```

### 3.12 流年信息（`liuNianInfo`）

数组格式，每个元素为 `[年份, 年龄, 干支]`：

```json
[
  ["1951", "1", "辛卯"],
  ["1952", "2", "壬辰"],
  ...
]
```

### 3.13 起运信息（`qiYunInfo`）

| 字段 | 说明 | 示例 |
|------|------|------|
| `solarQiYunDateStr` | 起运时间 | `"1959-10-24 14:00:00"` |
| `solarQiYun` | 起运说明 | `"出生7年11个月10天4小时后开始起运"` |
| `solarJiaoYun` | 交运时间 | `"逢己、甲年，寒露后14天交运"` |

---

## 4. 模型输入格式化

### 4.1 格式化流程

评测脚本 `acc_test/bazi_eval_multiturn.py` 中的 `format_bazi_for_ai()` 函数将排盘结果转换为 AI 可读的结构化文本。

**核心逻辑**：
1. 读取命主对应的排盘 JSON
2. 按命理逻辑分块组织信息
3. 生成可读性强的纯文本格式

### 4.2 格式化输出示例

以下是实际输入给模型的排盘信息格式：

```
【八字排盘结果】

==================================================
【基本信息】
==================================================
姓名：命主001
性别：女
命造：坤造
公历：1951-11-14 10:00:00
农历：一九五一年十月十六巳时
星期：周三
季节：孟冬
生肖：兔
星座：天蝎座

==================================================
【四柱八字】
==================================================
        年柱      月柱      日柱      时柱
天干：  辛        己        戊        丁
地支：  卯        亥        午        巳
干支：  辛卯      己亥      戊午      丁巳

【十神（主星）】
        伤官      劫财      元女      正印

【五行】
年柱：金木、月柱：土水、日柱：土火、时柱：火火
五行统计：木1、火3、土2、金1、水1
五行旺衰：水旺、木相、金休、土囚、火死

【藏干与副星】
年支卯藏干：['乙']，副星：['正官']
月支亥藏干：['壬', '甲']，副星：['偏财', '七杀']
日支午藏干：['丁', '己']，副星：['正印', '劫财']
时支巳藏干：['丙', '庚', '戊']，副星：['偏印', '食神', '比肩']

【十二长生】
年柱：沐浴、月柱：绝、日柱：帝旺、时柱：临官

【纳音】
年柱：松柏木、月柱：平地木、日柱：天上火、时柱：沙中土

【空亡】
年柱空亡：午未、日柱空亡：子丑

【胎元命宫】
胎元：庚寅
胎息：癸未
命宫：辛丑
身宫：癸巳

【神煞】
年柱神煞：['桃花']
月柱神煞：['太极贵人', '月德合', '正学堂', '金舆', '劫煞', '血刃']
日柱神煞：['天乙贵人', '六秀日', '十灵日', '九丑日', '孤鸾煞', '勾绞煞', '童子煞', '天喜', '空亡', '羊刃']
时柱神煞：['福星贵人', '德秀贵人', '国印', '禄神', '驿马', '流霞', '亡神', '丧门', '孤辰']

【干支关系】
天干关系：['戊辛相生', '丁辛相克', '丁己相生', '丁戊相生', '己辛相生']
地支关系：['午亥暗合', '卯午相破', '巳亥相冲', '亥卯半合木局']

【节气信息】
上一节：立冬 (1951-11-08 13:26:36)
下一节：大雪 (1951-12-08 06:02:18)
出生节气：立冬后5天20小时33分24秒

【起运信息】
起运时间：1959-10-24 14:00:00
起运说明：出生7年11个月10天4小时后开始起运
交运时间：逢己、甲年，寒露后14天交运

【大运信息】
大运排列（起始年份-起始年龄-干支）：
  第1步大运：9-18岁（1959-1968年）：庚子
  第2步大运：19-28岁（1969-1978年）：辛丑
  第3步大运：29-38岁（1979-1988年）：壬寅
  ...

【流年干支表】
格式：年份(干支,年龄)
  1951(辛卯,1岁) 1952(壬辰,2岁) 1953(癸巳,3岁) ...
  1960(庚子,10岁) 1961(辛丑,11岁) 1962(壬寅,12岁) ...
  ...

【重要流年提示】
正财流年：1956(丙申), 1966(丙午), 1976(丙辰), ...
偏财流年：1952(壬辰), 1962(壬寅), 1972(壬子), ...
正桃花年：1958(戊戌), 1970(庚戌), 1982(壬戌), ...
```

### 4.3 对话流程

**Multi-turn 评测流程**：

1. **System Prompt**：设置模型角色为八字命理专家
2. **第一轮**：发送完整排盘信息（如上格式）
3. **后续轮次**：逐题发送问题，模型给出分析与答案

```
用户：[排盘信息]
模型：收到排盘信息，准备分析...

用户：问题1：此命出生家境如何？
A. 富裕  B. 贫穷  C. 父从商母是村干部  D. 父母当官
模型：根据八字分析...答案：B

用户：问题2：婚姻如何？
...
```

### 4.4 匿名化处理

为防止模型通过名人信息"作弊"，格式化时会将真实姓名替换为匿名 ID（如"命主001"）。

---

## 5. 文件关联图

```
data/contest8_{year}.json          题目文件（问题 + 正确答案）
        │
        │ person_id 关联
        ▼
result/bazi-results/contest8_{year}_bazi_results.json   排盘结果
        │
        │ format_bazi_for_ai()
        ▼
    [格式化文本]  →  模型输入
        │
        │ 模型推理
        ▼
result/{model}/contest8_{year}_eval_*.json   评测结果
```

---

## 6. 复现指南

### 6.1 生成排盘结果

排盘结果需通过外部八字排盘服务生成。如果需要为新数据集生成排盘：

1. 准备出生信息（公历日期时间、性别、出生地）
2. 调用排盘 API 或本地排盘工具
3. 将结果保存为 `result/bazi-results/{dataset}_bazi_results.json`

### 6.2 运行评测

```bash
# Multi-turn 评测
python acc_test/bazi_eval_multiturn.py data/contest8_2025.json --model deepseek-chat

# Structured 评测
python acc_test/bazi_eval_structured.py data/contest8_2025.json --model deepseek-r1
```

### 6.3 查看格式化输出

如需查看实际的模型输入内容，可在评测脚本中添加调试输出：

```python
bazi_text = format_bazi_for_ai(bazi, anonymous_id="命主001")
print(bazi_text)
```

---

## 附录 A：十神对照表

| 十神 | 关系 | 六亲（男命） | 六亲（女命） |
|------|------|------------|------------|
| 比肩 | 同我者 | 兄弟 | 姐妹 |
| 劫财 | 同我者 | 姐妹 | 兄弟 |
| 食神 | 我生者 | 子女 | 子女 |
| 伤官 | 我生者 | 子女 | 子女 |
| 正财 | 我克者 | 妻子 | 父亲 |
| 偏财 | 我克者 | 父亲/情人 | 父亲 |
| 正官 | 克我者 | 子女 | 丈夫 |
| 七杀 | 克我者 | 子女 | 情人 |
| 正印 | 生我者 | 母亲 | 母亲 |
| 偏印 | 生我者 | 继母 | 继母 |

## 附录 B：常见干支关系

| 关系类型 | 说明 | 示例 |
|---------|------|------|
| 天干五合 | 甲己合、乙庚合、丙辛合、丁壬合、戊癸合 | `"甲己合土"` |
| 天干相冲 | 甲庚冲、乙辛冲、丙壬冲、丁癸冲 | `"甲庚相冲"` |
| 地支六合 | 子丑合、寅亥合、卯戌合、辰酉合、巳申合、午未合 | `"子丑合土"` |
| 地支六冲 | 子午冲、丑未冲、寅申冲、卯酉冲、辰戌冲、巳亥冲 | `"巳亥相冲"` |
| 地支三合 | 申子辰合水、亥卯未合木、寅午戌合火、巳酉丑合金 | `"亥卯未合木局"` |
| 地支相刑 | 子卯刑、寅巳申刑、丑戌未刑、辰午酉亥自刑 | `"子卯相刑"` |
| 地支相害 | 子未害、丑午害、寅巳害、卯辰害、申亥害、酉戌害 | `"子未相害"` |
| 地支相破 | 子酉破、丑辰破、寅亥破、卯午破、巳申破、未戌破 | `"卯午相破"` |
